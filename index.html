<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Draw Pattern</title>
  <style>
    /* --- RESET & LAYOUT --- */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: system-ui, -apple-system, sans-serif;
      background: #111; color: white;
      overflow: hidden;           
      position: fixed;            
      overscroll-behavior: none;  
      touch-action: none;         
    }
    
    .step {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      display: flex; flex-direction: column;
      transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      background: #111;
      overflow: hidden; 
    }
    .hidden-left { transform: translateX(-100%); }
    .hidden-right { transform: translateX(100%); }

    /* --- STEP 1: DRAW --- */
    #draw-container {
      flex: 1; position: relative;
      background: #222; 
      touch-action: none; 
      cursor: crosshair;
      overflow: hidden;
    }

    #backingImg {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover; 
      z-index: 0;
      display: none; 
      pointer-events: none; opacity: 0.8;
    }
    #drawCanvas { 
      position: absolute; inset: 0; 
      z-index: 10; 
      display: block; 
      touch-action: none;
    }

    /* --- PATTERN DRAWER --- */
    #patternDrawer {
      position: absolute; bottom: 100px; /* Positioned above the toolbar */
      left: 10px; right: 10px;
      height: 80px;
      background: rgba(30,30,30,0.95);
      border: 1px solid #444; border-radius: 12px;
      z-index: 30;
      display: flex; align-items: center; gap: 10px;
      overflow-x: auto; padding: 0 10px;
      
      transform: translateY(150%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      touch-action: pan-x; 
    }
    #patternDrawer.open { transform: translateY(0); }
    
    .pattern-thumb {
      width: 60px; height: 60px; flex-shrink: 0;
      border-radius: 8px; border: 2px solid transparent;
      object-fit: cover; cursor: pointer;
      background: #000;
    }
    .pattern-thumb:hover { border-color: white; }

    /* --- STEP 2: PREVIEW --- */
    #preview-container {
      flex: 1; position: relative;
      background: #000;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    #previewCanvas { width: 100%; height: 100%; object-fit: cover; }

    /* --- UI BARS --- */
    .ui-bar {
      z-index: 20;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      /* Safe Area padding ensures buttons aren't hidden behind Home bar */
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom)) 12px;
      display: flex; gap: 8px;
      align-items: center; justify-content: space-between;
      border-top: 1px solid rgba(255,255,255,0.15);
      touch-action: none;
      flex-wrap: wrap; /* Allows wrapping on very small screens */
    }
    .top-bar {
      border-bottom: 1px solid rgba(255,255,255,0.15);
      border-top: none;
      justify-content: center;
      padding: 12px; /* Reset padding for top bar */
    }
    h2 { margin: 0; font-size: 16px; font-weight: 600; letter-spacing: 0.5px; opacity: 0.9; }

    /* CONTROLS */
    .btn {
      background: #333; color: #eee; border: 1px solid #555;
      padding: 10px 16px; border-radius: 20px;
      font-weight: 600; font-size: 14px; cursor: pointer; white-space: nowrap;
      transition: background 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    
    .btn-icon { 
      padding: 0; width: 44px; height: 38px; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 18px;
    }
    .tool-active {
      background: #eee !important;
      color: #111 !important;
      border-color: #fff !important;
    }

    .control-group { display: flex; flex-direction: column; gap: 4px; }
    label { font-size: 9px; text-transform: uppercase; color: #aaa; letter-spacing: 0.5px; }
    
    select, input[type="color"] {
      background: #333; border: 1px solid #555;
      color: white; padding: 0 4px; border-radius: 6px;
      font-size: 14px; height: 32px; outline: none;
    }
    input[type="color"] { width: 40px; padding: 2px; }

    /* Range Sliders */
    input[type=range] {
      -webkit-appearance: none; width: 100%; background: transparent;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
      background: #fff; cursor: pointer; margin-top: -6px;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; cursor: pointer; background: #555; border-radius: 2px;
    }
    
    #imgUpload { display: none; }
  </style>
</head>
<body>

  <div id="step1" class="step">
    <div class="ui-bar top-bar">
      <h2>1. Create Tile</h2>
    </div>

    <div id="draw-container">
      <img id="backingImg" alt="Background" crossorigin="anonymous">
      <canvas id="drawCanvas"></canvas>
      <div id="patternDrawer"></div>
    </div>

    <div class="ui-bar">
      <div class="control-group">
        <label>Color</label>
        <input type="color" id="brushColor" value="#ffffff">
      </div>

      <div class="control-group">
        <label>Tools</label>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-icon tool-active" id="brushBtn" title="Brush">‚úèÔ∏è</button>
          <button class="btn btn-icon" id="eraserBtn" title="Eraser">üßº</button>
        </div>
      </div>

      <div class="control-group">
        <label>Base</label>
        <div style="display:flex; gap:6px;">
           <button class="btn btn-icon" id="libBtn" title="Library">üìö</button>
           <button class="btn btn-icon" id="uploadBtn" title="Upload">üìÇ</button>
        </div>
        <input type="file" id="imgUpload" accept="image/*">
      </div>

      <div style="flex:1"></div>
      
      <button class="btn" id="clearBtn" style="background:transparent; border:1px solid #666; color:#ccc;">Clear</button>
      
      <button class="btn" id="toStep2" style="background:white; color:black; border:none; padding: 10px 20px;">Next &rarr;</button>
    </div>
  </div>

  <div id="step2" class="step hidden-right">
    <div class="ui-bar top-bar">
      <h2>2. Style Pattern</h2>
    </div>

    <div id="preview-container">
      <canvas id="previewCanvas"></canvas>
    </div>

    <div class="ui-bar" style="flex-wrap: wrap; gap: 12px;">
      <div style="display:flex; width:100%; gap:12px;">
        <div class="control-group">
            <label>BG</label>
            <input type="color" id="bgColor" value="#000000">
        </div>

        <div class="control-group" style="flex:1;">
            <label>Size</label>
            <input type="range" id="sizeSlider" min="50" max="300" value="120">
        </div>

        <div class="control-group" style="flex:1;">
            <label>Gap</label>
            <input type="range" id="gapSlider" min="0" max="100" value="0">
        </div>
      </div>

      <div style="display:flex; width:100%; gap:12px; align-items:center;">
          <div class="control-group" style="flex:1;">
            <select id="tileMode" style="width:100%">
              <option value="grid">Grid</option>
              <option value="brick">Brick</option>
              <option value="hex">Hex</option>
            </select>
          </div>
          
          <button class="btn" id="backBtn" style="background:transparent; border:1px solid #666; color:#ccc;">&larr;</button>
          <button class="btn" id="saveBtn" style="background:white; color:black; flex:2;">View in AR &rarr;</button>
      </div>
    </div>
  </div>

  <script>
    // --- VARIABLES ---
    const drawCanvas = document.getElementById("drawCanvas");
    const ctx = drawCanvas.getContext("2d");
    const backingImg = document.getElementById("backingImg");
    const previewCanvas = document.getElementById("previewCanvas");
    const pctx = previewCanvas.getContext("2d");
    
    // Tools
    let isDrawing = false;
    let lastX = 0; let lastY = 0;
    let currentMode = 'brush'; 
    const brushBtn = document.getElementById("brushBtn");
    const eraserBtn = document.getElementById("eraserBtn");

    // ============================================================
    //  üëá YOUR IMAGE LIST üëá
    // ============================================================
    const presetPatterns = [
      "patterns/p1.png", 
      "patterns/p2.png",
      "patterns/p3.png",
      "patterns/p4.png",
      "patterns/p5.png",
      "patterns/p6.png",
      "patterns/p7.png",
      "patterns/p8.png",
      "patterns/p9.png",
      "patterns/p10.png",
      "patterns/p11.png"
    ];
    // ============================================================

    // --- INIT PATTERN DRAWER ---
    const patternDrawer = document.getElementById("patternDrawer");
    const libBtn = document.getElementById("libBtn");

    presetPatterns.forEach(src => {
      const img = document.createElement("img");
      img.src = src;
      img.className = "pattern-thumb";
      img.onerror = () => { img.style.display = 'none'; }; 
      img.addEventListener("click", (e) => {
        e.stopPropagation();
        setBackingImage(src);
        patternDrawer.classList.remove("open");
      });
      patternDrawer.appendChild(img);
    });

    libBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        patternDrawer.classList.toggle("open");
    });

    // --- 1. SETUP CANVAS ---
    function resizeDrawCanvas() {
      const container = document.getElementById("draw-container");
      if (drawCanvas.width !== container.clientWidth || drawCanvas.height !== container.clientHeight) {
        const saved = drawCanvas.toDataURL();
        drawCanvas.width = container.clientWidth;
        drawCanvas.height = container.clientHeight;
        
        ctx.lineWidth = 12;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        updateToolSettings();

        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0);
        img.src = saved;
      }
    }
    window.addEventListener("resize", resizeDrawCanvas);
    setTimeout(resizeDrawCanvas, 10);

    // --- 2. TOOLS ---
    function updateToolSettings() {
      if (currentMode === 'brush') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = document.getElementById("brushColor").value;
        brushBtn.classList.add("tool-active");
        eraserBtn.classList.remove("tool-active");
      } else {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = "rgba(0,0,0,1)";
        brushBtn.classList.remove("tool-active");
        eraserBtn.classList.add("tool-active");
      }
    }
    brushBtn.addEventListener("click", () => { currentMode = 'brush'; updateToolSettings(); });
    eraserBtn.addEventListener("click", () => { currentMode = 'eraser'; updateToolSettings(); });
    document.getElementById("brushColor").addEventListener("input", () => {
      if (currentMode === 'eraser') currentMode = 'brush';
      updateToolSettings();
    });

    // --- 3. DRAWING LOGIC ---
    function startDraw(e) {
      patternDrawer.classList.remove("open");
      if(e.cancelable) e.preventDefault();
      isDrawing = true;
      const { x, y } = getPos(e);
      lastX = x; lastY = y;
    }
    function draw(e) {
      if(e.cancelable) e.preventDefault(); 
      if (!isDrawing) return;
      const { x, y } = getPos(e);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      lastX = x; lastY = y;
    }
    function endDraw() { isDrawing = false; }
    
    function getPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }
    
    drawCanvas.addEventListener("mousedown", startDraw);
    drawCanvas.addEventListener("mousemove", draw);
    drawCanvas.addEventListener("mouseup", endDraw);
    drawCanvas.addEventListener("touchstart", startDraw, { passive: false });
    drawCanvas.addEventListener("touchmove", draw, { passive: false });
    drawCanvas.addEventListener("touchend", endDraw);

    // --- CLEAR FUNCTIONALITY (Updated) ---
    document.getElementById("clearBtn").addEventListener("click", () => {
      // 1. Clear the drawing canvas
      ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
      // 2. Clear the background image
      backingImg.src = "";
      backingImg.style.display = "none";
    });

    // --- 4. IMAGE HANDLING ---
    function setBackingImage(src) {
      backingImg.crossOrigin = "Anonymous";
      backingImg.src = src;
      backingImg.style.display = "block";
    }

    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("imgUpload");
    uploadBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => setBackingImage(event.target.result);
      reader.readAsDataURL(file);
    });

    // --- 5. COMPOSITE & PREVIEW ---
    function getCompositeCanvas() {
      const c = document.createElement("canvas");
      c.width = drawCanvas.width;
      c.height = drawCanvas.height;
      const cx = c.getContext("2d");

      if (backingImg.style.display !== 'none' && backingImg.src) {
        const img = backingImg;
        const nw = img.naturalWidth || 100;
        const nh = img.naturalHeight || 100;
        const canvasRatio = c.width / c.height;
        const imgRatio = nw / nh;
        
        let dw, dh, dx, dy;
        if (imgRatio > canvasRatio) {
          dh = c.height; dw = c.height * imgRatio;
          dx = (c.width - dw) / 2; dy = 0;
        } else {
          dw = c.width; dh = c.width / imgRatio;
          dx = 0; dy = (c.height - dh) / 2;
        }
        try { cx.drawImage(img, dx, dy, dw, dh); } catch(e) {}
      }
      cx.drawImage(drawCanvas, 0, 0);
      return c;
    }

    // Navigation
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    document.getElementById("toStep2").addEventListener("click", () => {
      renderPatternPreview(); 
      step1.classList.add("hidden-left");
      step2.classList.remove("hidden-right");
    });
    document.getElementById("backBtn").addEventListener("click", () => {
      step2.classList.add("hidden-right");
      step1.classList.remove("hidden-left");
    });

    // --- 6. PREVIEW GENERATION ---
    const bgColorInput = document.getElementById("bgColor");
    const tileModeInput = document.getElementById("tileMode");
    const sizeSlider = document.getElementById("sizeSlider");
    const gapSlider = document.getElementById("gapSlider");

    [bgColorInput, tileModeInput, sizeSlider, gapSlider].forEach(el => {
        el.addEventListener("input", renderPatternPreview);
    });

    function renderPatternPreview() {
      const source = getCompositeCanvas();
      const container = document.getElementById("preview-container");
      previewCanvas.width = container.clientWidth;
      previewCanvas.height = container.clientHeight;

      pctx.fillStyle = bgColorInput.value;
      pctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);

      const baseSize = parseInt(sizeSlider.value); 
      const gap = parseInt(gapSlider.value);      

      const ratio = source.width / source.height;
      const tileW = baseSize;
      const tileH = baseSize / ratio; 

      const strideX = tileW + gap;
      const strideY = tileH + gap;

      const mode = tileModeInput.value;
      const cols = Math.ceil(previewCanvas.width / strideX) + 1;
      const rows = Math.ceil(previewCanvas.height / strideY) + 1;

      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          let dx = x * strideX;
          let dy = y * strideY;
          
          if (mode === 'brick') {
            if (y % 2 === 1) dx -= strideX / 2;
          } else if (mode === 'hex') {
            dy = y * (strideY * 0.85);
            if (y % 2 === 1) dx -= strideX / 2;
          }
          
          pctx.drawImage(source, dx, dy, tileW, tileH);
        }
      }
    }

    // --- 7. SAVE ---
    document.getElementById("saveBtn").addEventListener("click", () => {
      const source = getCompositeCanvas();
      const texCanvas = document.createElement("canvas");
      texCanvas.width = 1024; texCanvas.height = 1024;
      const tctx = texCanvas.getContext("2d");

      tctx.fillStyle = bgColorInput.value;
      tctx.fillRect(0, 0, 1024, 1024);

      const refScreenW = 360;
      const visualSize = parseInt(sizeSlider.value);
      const visualGap = parseInt(gapSlider.value);
      const visualStride = visualSize + visualGap;
      const colsPerScreen = refScreenW / visualStride;

      const texStrideX = 1024 / colsPerScreen;
      
      const scaleRatio = texStrideX / visualStride;
      const texTileW = visualSize * scaleRatio;
      const texTileH = (visualSize / (source.width / source.height)) * scaleRatio;
      const texStrideY = (visualSize / (source.width / source.height) + visualGap) * scaleRatio;

      const mode = tileModeInput.value;
      const REPEAT_COLS = Math.ceil(1024 / texStrideX) + 2;
      const REPEAT_ROWS = Math.ceil(1024 / texStrideY) + 2;

      for (let y = -1; y < REPEAT_ROWS; y++) {
        for (let x = -1; x < REPEAT_COLS; x++) {
          let dx = x * texStrideX;
          let dy = y * texStrideY;
          
          if (mode === 'brick') {
            if (y % 2 === 1) dx -= texStrideX / 2;
          } else if (mode === 'hex') {
            dy = y * (texStrideY * 0.85);
            if (y % 2 === 1) dx -= texStrideX / 2;
          }
          
          tctx.drawImage(source, dx, dy, texTileW, texTileH);
        }
      }

      localStorage.setItem("pattern_png", texCanvas.toDataURL("image/png"));
      location.href = "ar.html";
    });
  </script>
</body>
</html>