<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pattern AR (Debug Mode)</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; font-family: sans-serif; }
    video, .a-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    /* Fix Z-Index so we can see the camera */
    video { z-index: 0 !important; opacity: 1 !important; }
    .a-canvas { z-index: 1 !important; background: transparent !important; pointer-events: none; }
    
    #overlay { position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; color: white; flex-direction: column; padding: 20px; text-align: center; }
    .btn { background: #444; border: 1px solid #fff; padding: 12px 24px; margin-top: 10px; cursor: pointer; border-radius: 8px; font-weight: bold; }
    
    /* The Hint Box - Red background if error */
    #hint { 
      position: fixed; bottom: 20px; left: 5%; right: 5%; 
      background: rgba(0,0,0,0.7); color: #fff; 
      padding: 15px; border-radius: 10px; text-align: center; z-index: 200; 
      font-size: 16px; border: 1px solid rgba(255,255,255,0.3);
    }
  </style>
</head>

<body>
  <div id="overlay">
    <h2>AR Debugger</h2>
    <p>Please confirm your setup:</p>
    <ul style="text-align:left; font-size:14px; margin-bottom:20px;">
      <li>1. Address bar starts with <b>http://</b> (NOT file://)</li>
      <li>2. "targets.mind" is inside a folder named "targets"</li>
    </ul>
    <div class="btn" id="start">Start AR</div>
    <div class="btn" onclick="location.href='./'">Go Back</div>
  </div>

  <div id="hint">Waiting for user...</div>

  <canvas id="texCanvas" width="16" height="16" style="display:none"></canvas>
  <canvas id="tileCanvas" width="1024" height="1024" style="display:none"></canvas>

  <script>
    // --- CONFIGURATION ---
    // Double check this path matches your folder exactly
    const TARGET_PATH = "targets/targets.mind"; 
    // ---------------------

    const hint = document.getElementById("hint");
    const png = localStorage.getItem("pattern_png");
    
    // 1. Helper to tile the pattern
    function prepareTexture() {
      if (!png) return false;
      const N = parseInt(localStorage.getItem("pattern_N") || "16");
      const REPEAT = 6;
      
      const tex = document.getElementById("texCanvas");
      const tile = document.getElementById("tileCanvas");
      tex.width = N; tex.height = N;

      const img = new Image();
      img.onload = () => {
        tex.getContext("2d").drawImage(img,0,0,N,N);
        const ctx = tile.getContext("2d");
        ctx.fillStyle = "black"; ctx.fillRect(0,0,1024,1024);
        
        const cell = Math.floor(1024 / (N * REPEAT));
        const T = N * cell;
        const off = (1024 - (T * REPEAT)) / 2;

        for(let y=0; y<REPEAT; y++) {
          for(let x=0; x<REPEAT; x++) {
            ctx.drawImage(tex, 0,0,N,N, off+x*T, off+y*T, T,T);
          }
        }
      };
      img.src = png;
      return true;
    }

    // 2. The File Checker
    async function checkFileAndStart() {
      hint.style.background = "rgba(0,0,0,0.7)";
      hint.textContent = `Looking for: ${TARGET_PATH} ...`;

      try {
        const resp = await fetch(TARGET_PATH);
        if (!resp.ok) {
          throw new Error(`File not found (Status: ${resp.status})`);
        }
        // If we get here, the file exists!
        hint.textContent = "File found! Initializing Camera...";
        startMindAR();
      } catch (err) {
        console.error(err);
        hint.style.background = "rgba(200, 0, 0, 0.9)"; // Red background
        hint.innerHTML = `
          <b>ERROR LOADING TARGETS!</b><br>
          Browser said: "${err.message}"<br><br>
          1. Is the file inside the "targets" folder?<br>
          2. Are you using a Local Server (http://)?
        `;
      }
    }

    // 3. Start A-Frame
    function startMindAR() {
      document.body.insertAdjacentHTML("beforeend", `
        <a-scene 
          mindar-image="imageTargetSrc: ${TARGET_PATH}; autoStart: true; uiLoading: no; uiScanning: no;" 
          embedded renderer="alpha: true; colorManagement: true;"
          vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
          
          <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

          <a-entity mindar-image-target="targetIndex: 0" id="targetEntity">
            <a-plane width="1" height="1" position="0 0 0" 
              material="shader: flat; transparent: true; opacity: 1; side: double;"
              id="patternPlane"></a-plane>
          </a-entity>
        </a-scene>
      `);

      // Attach texture to plane
      const plane = document.getElementById("patternPlane");
      const tileCanvas = document.getElementById("tileCanvas");
      const tex = new THREE.CanvasTexture(tileCanvas);
      tex.magFilter = THREE.NearestFilter;
      
      plane.addEventListener("loaded", () => {
        const mesh = plane.getObject3D("mesh");
        if(mesh) {
           mesh.material.map = tex;
           mesh.material.needsUpdate = true;
        }
      });

      // Events
      const scene = document.querySelector("a-scene");
      scene.addEventListener("arReady", () => { hint.textContent = "âœ… Camera Ready! Scan now."; });
      scene.addEventListener("arError", (e) => { 
        hint.style.background = "red";
        hint.textContent = "âŒ Camera Error: " + e.detail.error; 
      });

      const target = document.getElementById("targetEntity");
      target.addEventListener("targetFound", () => { hint.textContent = "ðŸŽ¯ MARKER FOUND!"; });
      target.addEventListener("targetLost", () => { hint.textContent = "ðŸ‘€ Scanning..."; });
    }

    // Init
    if (prepareTexture()) {
      document.getElementById("start").addEventListener("click", () => {
        document.getElementById("overlay").style.display = "none";
        checkFileAndStart();
      });
    } else {
      hint.textContent = "No pattern data found. Go back.";
    }
  </script>
</body>
</html>